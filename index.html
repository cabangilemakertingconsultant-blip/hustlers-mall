<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hustling Mall</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { background:#111; color:#fff; font-family:'Segoe UI',sans-serif; padding:15px; }
h2,h3 { color:#FFD700; text-align:center; margin-bottom:15px; }
.store-logo { max-height:100px; display:block; margin:0 auto 10px; }
.card { border-radius:10px; background:#1c1c1c; border:1px solid #FFD700; margin-bottom:20px; transition:transform .2s; }
.card:hover { transform:scale(1.02); }
.product-img { width:100%; height:200px; object-fit:cover; border-radius:5px; }
.btn-whatsapp, .btn-admin { border:none; border-radius:5px; width:100%; margin-top:5px; }
.btn-whatsapp { background:#25D366; color:#fff; }
.btn-admin { background:#FFD700; color:#111; font-weight:bold; }
.badge-featured { background:#FFD700; color:#111; font-weight:bold; padding:3px 6px; position:absolute; top:10px; left:10px; border-radius:5px; }
.filter-container { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.select-category, #productSearchInput, #storeSearchInput { padding:5px 10px; border-radius:5px; border:none; }
.crossed { text-decoration:line-through; color:#ff0000; opacity:0.6; }
.btn-open { background:#FFD700; color:#111; border:none; width:100%; font-weight:bold; margin-top:5px; }
.store-status { display:block; text-align:center; margin-bottom:10px; }
.search-box { max-width:400px; margin:0 auto 25px; }
input { border-radius:6px; border:none; padding:8px 12px; width:100%; }
</style>
</head>
<body>

<!-- ADMIN BUTTON -->
<div class="d-flex justify-content-center mb-3">
  <a href="admin.html" class="btn btn-admin w-50">Go to Admin Panel</a>
</div>

<!-- MARKETPLACE VIEW -->
<div id="marketplaceView">
  <h2>üõç Hustling Mall Marketplace</h2>

  <!-- Featured Products -->
  <div id="featuredProductsSection" style="display:none;">
    <h3>üî• Featured Products</h3>
    <div class="row" id="featuredProductsContainer"></div>
  </div>

  <!-- Store Search -->
  <div class="search-box">
    <input id="storeSearchInput" placeholder="Search stores...">
  </div>

  <!-- All Stores -->
  <div class="row" id="storesContainer"></div>
</div>

<!-- STORE VIEW -->
<div id="storeView" style="display:none;">
  <img id="storeLogo" class="store-logo" src="" alt="">
  <h2 id="storeName"></h2>
  <p id="storeDirections" class="text-center"></p>
  <div class="d-flex justify-content-center mb-3">
    <a id="storeWhatsapp" target="_blank" class="btn btn-whatsapp w-50">Contact on WhatsApp</a>
  </div>

  <div class="filter-container">
    <input type="text" id="productSearchInput" placeholder="Search products">
    <select id="categorySelect" class="select-category">
      <option value="">All Categories</option>
    </select>
  </div>

  <div class="row" id="productsContainer"></div>

  <div class="d-flex justify-content-center mt-3">
    <button class="btn btn-warning" onclick="backToMarketplace()">Back to Marketplace</button>
  </div>
</div>

<script>
const supabase = supabase.createClient(
  'https://mcxlapbqbnguyedtsjmf.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jeGxhcGJxYm5ndXllZHRzam1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNzI3MzAsImV4cCI6MjA4Mzk0ODczMH0.p82ogUSUiCWJye6fjZu9M0uBrCLO_Dpl0FpAqO7RQuU'
);

let allStores = [];
let allProducts = [];
let storeData = null;

function getHashStoreId(){
  const hash = window.location.hash;
  if(hash.startsWith('#store=')) return hash.replace('#store=','');
  return null;
}

function getLicenseStatus(store){
  if(!store.license_start) return 'Trial';
  const now = new Date();
  const start = new Date(store.license_start);
  const end = new Date(store.license_end);
  const graceEnd = new Date(end); graceEnd.setDate(graceEnd.getDate()+7);
  if(now<start) return 'Trial';
  if(now>=start && now<=end) return 'Active';
  if(now>end && now<=graceEnd) return 'Grace';
  return 'Expired';
}
function isProductActive(store){ const status = getLicenseStatus(store); return status==='Active'||status==='Grace'; }

// FEATURED PRODUCTS
async function loadFeaturedProducts(){
  const { data, error } = await supabase
    .from('products')
    .select('*, stores(*)')
    .eq('featured', true)
    .order('created_at', { ascending: false });
  if(error){ console.log('Failed to load featured products'); return; }

  const featured = (data || []).filter(p => {
    const store = p.stores;
    if(!store) return false;
    const status = getLicenseStatus(store);
    return status === 'Active' || status === 'Grace';
  });

  if(featured.length === 0) return;

  document.getElementById('featuredProductsSection').style.display = 'block';
  document.getElementById('featuredProductsContainer').innerHTML = featured.map(p => {
    const img = p.images?.[0]||'';
    return `
    <div class="col-md-3">
      <div class="card p-2 position-relative">
        <img src="${img}" class="product-img mb-2">
        <h6>${p.name}</h6>
        <p>R${p.price}</p>
        <a href="#store=${p.store_id}" class="btn btn-open btn-sm">Visit Store</a>
      </div>
    </div>`;
  }).join('');
}

// MARKETPLACE FUNCTIONS
async function loadStores(){
  const { data, error } = await supabase.from('stores').select('*').order('name');
  if(error){ alert('Failed to load stores'); return; }
  allStores = data || [];
  renderStores();
}

function renderStores(){
  const search = document.getElementById('storeSearchInput').value.toLowerCase();
  const filtered = allStores
    .filter(store => ['Active','Grace'].includes(getLicenseStatus(store)))
    .filter(store => store.name.toLowerCase().includes(search));

  document.getElementById('storesContainer').innerHTML = filtered.map(store=>{
    return `
    <div class="col-md-4">
      <div class="card">
        ${store.logo?`<img src="${store.logo}" class="store-logo">`:''}
        <h5 class="text-center">${store.name}</h5>
        <p class="text-center">${store.province||''}</p>
        <span class="store-status">${getLicenseStatus(store)}</span>
        <a href="#store=${store.id}" class="btn btn-open mt-2">Visit Store</a>
      </div>
    </div>`;
  }).join('');
}

document.getElementById('storeSearchInput').addEventListener('input', renderStores);

// STORE VIEW FUNCTIONS
async function loadStore(storeId){
  const { data: store, error } = await supabase.from('stores').select('*').eq('id',storeId).single();
  if(error || !store){ alert('Store unavailable'); backToMarketplace(); return; }
  storeData = store;

  document.getElementById('marketplaceView').style.display='none';
  document.getElementById('storeView').style.display='block';

  document.getElementById('storeLogo').src = store.logo||'';
  document.getElementById('storeName').textContent = store.name||'';
  document.getElementById('storeDirections').textContent = store.directions||'';
  document.getElementById('storeWhatsapp').href = `https://wa.me/${store.whatsapp}?text=Hello, I found your store on Hustling Mall`;

  loadProducts(storeId);
}

async function loadProducts(storeId){
  const { data, error } = await supabase.from('products').select('*').eq('store_id',storeId).order('featured',{ascending:false});
  if(error){ alert('Failed to load products'); return; }
  allProducts = data || [];
  populateCategories();
  renderProducts();
}

function populateCategories(){
  const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
  const select = document.getElementById('categorySelect');
  select.innerHTML = '<option value="">All Categories</option>'+categories.map(c=>`<option value="${c}">${c}</option>`).join('');
}

function renderProducts(){
  const search = document.getElementById('productSearchInput').value.toLowerCase();
  const category = document.getElementById('categorySelect').value;
  const active = isProductActive(storeData);

  const filtered = allProducts.filter(p =>
    (!category || p.category === category) &&
    (p.name.toLowerCase().includes(search) || (p.description||'').toLowerCase().includes(search))
  );

  document.getElementById('productsContainer').innerHTML = filtered.map(p=>{
    const img = p.images?.[0]||'';
    const crossedClass = active?'':'crossed';

    return `
    <div class="col-md-4">
      <div class="card p-2 position-relative">
        ${p.featured?'<span class="badge-featured">TOP</span>':''}
        <img src="${img}" class="product-img mb-2 ${crossedClass}">
        <h5 class="${crossedClass}">${p.name}</h5>
        <p class="${crossedClass}">Price: R${p.price}</p>
        <p class="${crossedClass}">${p.description||''}</p>
        <a href="https://wa.me/${storeData.whatsapp}?text=${encodeURIComponent(`Hi, I'm interested in ${p.name} (R${p.price})`)}"
          target="_blank" class="btn-whatsapp mt-2 ${crossedClass}" ${active?'':'disabled'}>WhatsApp</a>
      </div>
    </div>`;
  }).join('');
}

document.getElementById('productSearchInput').addEventListener('input', renderProducts);
document.getElementById('categorySelect').addEventListener('change', renderProducts);

function backToMarketplace(){
  window.location.hash = '';
  document.getElementById('storeView').style.display='none';
  document.getElementById('marketplaceView').style.display='block';
  renderStores();
}

// HASH CHANGE LISTENER
window.addEventListener('hashchange', ()=>{
  const hashStoreId = getHashStoreId();
  if(hashStoreId){ loadStore(hashStoreId); }
  else { backToMarketplace(); }
});

// INITIAL LOAD
const initialStoreId = getHashStoreId();
if(initialStoreId){ loadStore(initialStoreId); } 
else { loadFeaturedProducts(); loadStores(); }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
