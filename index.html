<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hustling Mall | Marketplace</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family:'Segoe UI',sans-serif; background:#111; color:#fff; padding:15px; }
h2 { color:#FFD700; text-align:center; margin-bottom:20px; }
.button-container { display:flex; justify-content:center; gap:20px; margin-bottom:20px; flex-wrap:wrap; }
.btn-business { background:#FFD700; color:#111; font-weight:bold; padding:10px 20px; border:none; border-radius:10px; text-decoration:none; transition:0.3s; }
.btn-business:hover { background:#ffc107; color:#000; }
.card { border-radius:10px; background:#1c1c1c; border:1px solid #FFD700; margin-bottom:20px; position:relative; }
.product-img { width:100%; height:200px; object-fit:cover; border-radius:5px; }
.store-logo { max-height:50px; object-fit:contain; margin-bottom:5px; }
.btn-whatsapp { background:#25D366; color:#fff; border:none; border-radius:5px; width:100%; }
.badge-featured { background:#FFD700; color:#111; font-weight:bold; padding:3px 6px; position:absolute; top:10px; left:10px; border-radius:5px; }
.filter-container { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.select-category, #searchInput, #sortSelect { padding:5px 10px; border-radius:5px; border:none; }
</style>
</head>
<body>

<h2>Hustling Mall Marketplace</h2>

<!-- Admin Buttons -->
<div class="button-container">
  <a href="master.html" class="btn-business">Master Admin Panel</a>
  <a href="admin.html" class="btn-business">Store Admin Panel</a>
</div>

<!-- Filters & Sort -->
<div class="filter-container">
  <input type="text" id="searchInput" placeholder="Search Products...">
  <select id="categorySelect" class="select-category">
    <option value="">All Categories</option>
  </select>
  <select id="sortSelect" class="select-category">
    <option value="featured">Top Featured</option>
    <option value="newest">Newest</option>
    <option value="priceLow">Price: Low → High</option>
    <option value="priceHigh">Price: High → Low</option>
  </select>
</div>

<div class="row" id="productsContainer"></div>

<script>
const supabase = supabase.createClient(
  'https://mcxlapbqbnguyedtsjmf.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jeGxhcGJxYm5ndXllZHRzam1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNzI3MzAsImV4cCI6MjA4Mzk0ODczMH0.p82ogUSUiCWJye6fjZu9M0uBrCLO_Dpl0FpAqO7RQuU'
);

let allProducts = [];

// Load products and categories
async function loadMarketplace(){
  const { data: products, error } = await supabase
    .from('products')
    .select('*, stores(*)');

  if(error){ alert(error.message); return; }

  // Only active stores
  allProducts = products.filter(p => p.stores && (!p.stores.license_end || new Date(p.stores.license_end) > new Date()));

  // Boost products from stores with paid license
  allProducts.forEach(p => {
    p.boost = p.stores.license_end ? true : false;
  });

  populateCategories();
  renderProducts();
}

// Populate category select
function populateCategories(){
  const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
  const select = document.getElementById('categorySelect');
  select.innerHTML = '<option value="">All Categories</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
}

// Render products based on search, category, and sort
function renderProducts(){
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const selectedCategory = document.getElementById('categorySelect').value;
  const sortValue = document.getElementById('sortSelect').value;

  let filtered = allProducts
    .filter(p => (!selectedCategory || p.category === selectedCategory) &&
                 (p.name.toLowerCase().includes(searchTerm) || (p.description || '').toLowerCase().includes(searchTerm)));

  // Sorting
  if(sortValue==='featured') filtered.sort((a,b) => (b.featured || b.boost ? 1 : 0) - (a.featured || a.boost ? 1 : 0));
  else if(sortValue==='newest') filtered.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
  else if(sortValue==='priceLow') filtered.sort((a,b) => a.price - b.price);
  else if(sortValue==='priceHigh') filtered.sort((a,b) => b.price - a.price);

  const container = document.getElementById('productsContainer');
  container.innerHTML = filtered.map(p => {
      const images = p.images || [];
      const imgSrc = images[0] || '';
      const store = p.stores;
      return `
      <div class="col-md-4">
        <div class="card p-2">
          ${(p.featured || p.boost) ? '<span class="badge-featured">TOP</span>' : ''}
          <img src="${imgSrc}" class="product-img mb-2">
          <h5>${p.name}</h5>
          <p>Store: ${store.name || 'Unknown'}</p>
          <p>Price: R${p.price} ${p.discount ? `| Discount: ${p.discount}%` : ''}</p>
          <p>${p.promotion || ''}</p>
          <a href="https://wa.me/${store.whatsapp}?text=${encodeURIComponent(`Hi! I'm interested in ${p.name} priced at R${p.price}.`) }" target="_blank" class="btn-whatsapp mt-2">WhatsApp</a>
        </div>
      </div>`;
  }).join('');
}

// Event listeners
document.getElementById('searchInput').addEventListener('input', renderProducts);
document.getElementById('categorySelect').addEventListener('change', renderProducts);
document.getElementById('sortSelect').addEventListener('change', renderProducts);

// Load on page load
loadMarketplace();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>