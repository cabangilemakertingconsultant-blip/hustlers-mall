<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hustling Mall | Store</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family:'Segoe UI',sans-serif; background:#111; color:#fff; padding:15px; }
h2, h3 { color:#FFD700; text-align:center; margin-bottom:15px; }
.store-logo { max-height:100px; display:block; margin:0 auto 10px; }
.card { border-radius:10px; background:#1c1c1c; border:1px solid #FFD700; margin-bottom:20px; }
.product-img { width:100%; height:200px; object-fit:cover; border-radius:5px; }
.btn-whatsapp { background:#25D366; color:#fff; border:none; border-radius:5px; width:100%; }
.badge-featured { background:#FFD700; color:#111; font-weight:bold; padding:3px 6px; position:absolute; top:10px; left:10px; border-radius:5px; }
.filter-container { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.select-category, #searchInput { padding:5px 10px; border-radius:5px; border:none; }
#inactiveMessage { text-align:center; color:red; font-size:1.2rem; margin-top:30px; }
</style>
</head>
<body>

<!-- Store Header -->
<img id="storeLogo" class="store-logo" src="" alt="">
<h2 id="storeName"></h2>
<p id="storeDirections" class="text-center"></p>

<div class="d-flex justify-content-center mb-3">
  <a id="storeWhatsapp" target="_blank" class="btn btn-whatsapp w-50">Contact on WhatsApp</a>
</div>

<!-- Filters -->
<div class="filter-container">
  <input type="text" id="searchInput" placeholder="Search products">
  <select id="categorySelect" class="select-category">
    <option value="">All Categories</option>
  </select>
</div>

<!-- Inactive Message -->
<p id="inactiveMessage" style="display:none;">This store is inactive. Please contact the owner.</p>

<!-- Products -->
<div class="row" id="productsContainer"></div>

<script>
const supabase = supabase.createClient(
  'https://mcxlapbqbnguyedtsjmf.supabase.co',
  'PUBLIC_ANON_KEY_HERE'
);

const params = new URLSearchParams(window.location.search);
const storeId = params.get('id');

if (!storeId) {
  alert('Store not found');
  throw new Error('Missing store id');
}

let allProducts = [];
let storeData = null;

// =====================
// License Status
// =====================
function getLicenseStatus(store){
  if(!store.license_start) return {status:'Trial',daysLeft:7};
  const now = new Date();
  const end = new Date(store.license_end);
  const graceEnd = new Date(end); graceEnd.setDate(graceEnd.getDate()+7);
  if(now<=end) return {status:'Active',daysLeft: Math.ceil((end-now)/(1000*60*60*24))};
  if(now<=graceEnd) return {status:'Grace',daysLeft: Math.ceil((graceEnd-now)/(1000*60*60*24))};
  return {status:'Expired',daysLeft:0};
}

// =====================
// Load Store
// =====================
async function loadStore() {
  const { data: store, error } = await supabase
    .from('stores')
    .select('*')
    .eq('id', storeId)
    .single();

  if(error) {
    alert('Store unavailable');
    return;
  }

  storeData = store;

  const license = getLicenseStatus(storeData);
  if(license.status==='Expired'){
    document.getElementById('inactiveMessage').style.display='block';
    document.getElementById('productsContainer').style.display='none';
    document.getElementById('searchInput').style.display='none';
    document.getElementById('categorySelect').style.display='none';
  } else {
    document.getElementById('inactiveMessage').style.display='none';
    document.getElementById('productsContainer').style.display='flex';
    document.getElementById('searchInput').style.display='inline-block';
    document.getElementById('categorySelect').style.display='inline-block';
  }

  document.getElementById('storeLogo').src = store.logo || '';
  document.getElementById('storeName').textContent = store.name || '';
  document.getElementById('storeDirections').textContent = store.directions || '';
  document.getElementById('storeWhatsapp').href =
    `https://wa.me/${store.whatsapp}?text=Hello, I found your store on Hustling Mall`;

  loadProducts();
}

// =====================
// Load Products
// =====================
async function loadProducts() {
  const { data, error } = await supabase
    .from('products')
    .select('*')
    .eq('store_id', storeId)
    .eq('status', 'active')
    .order('featured', { ascending: false });

  if(error) {
    alert('Failed to load products');
    return;
  }

  allProducts = data;
  populateCategories();
  renderProducts();
}

// =====================
// Categories
// =====================
function populateCategories() {
  const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
  const select = document.getElementById('categorySelect');
  select.innerHTML =
    '<option value="">All Categories</option>' +
    categories.map(c => `<option value="${c}">${c}</option>`).join('');
}

// =====================
// Render Products
// =====================
function renderProducts() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const category = document.getElementById('categorySelect').value;

  const filtered = allProducts.filter(p =>
    (!category || p.category === category) &&
    (p.name.toLowerCase().includes(search) ||
     (p.description || '').toLowerCase().includes(search))
  );

  document.getElementById('productsContainer').innerHTML = filtered.map(p => {
    const img = p.images?.[0] || '';
    return `
      <div class="col-md-4">
        <div class="card p-2 position-relative">
          ${p.featured ? '<span class="badge-featured">TOP</span>' : ''}
          <img src="${img}" class="product-img mb-2">
          <h5>${p.name}</h5>
          <p>Price: R${p.price}</p>
          <p>${p.description || ''}</p>
          <a href="https://wa.me/${storeData.whatsapp}?text=${encodeURIComponent(
            `Hi, I'm interested in ${p.name} (R${p.price})`
          )}" target="_blank" class="btn-whatsapp mt-2">
            WhatsApp
          </a>
        </div>
      </div>`;
  }).join('');
}

// =====================
// Events
// =====================
document.getElementById('searchInput').addEventListener('input', renderProducts);
document.getElementById('categorySelect').addEventListener('change', renderProducts);

// =====================
// Init
// =====================
loadStore();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>